# PEM セル法アルゴリズム ベンチマーク実行手順

## 概要
このガイドは、PEM（粒子要素法）シミュレーションにおけるセル法アルゴリズムの効果を定量的に評価するためのベンチマーク実行手順を説明します。

## 実装した機能

### 1. セル法アルゴリズム制御機能
- `DISABLE_CELL_ALGORITHM`: セル法アルゴリズムのON/OFF制御
- `CELL_SIZE_OVERRIDE`: セルサイズの手動設定
- アルゴリズムOFF時は計算領域全体を1つのセルとして扱い、実質的に総当たり計算を実行

### 2. 詳細な計算時間測定
- 総実行時間
- 1ステップあたりの平均時間
- 粒子数、セル数の情報
- アルゴリズムの状態表示

### 3. バッチ処理スクリプト
- `benchmark_job.sh`: 基本的なベンチマーク（ON/OFF比較）
- `detailed_benchmark.sh`: 詳細ベンチマーク（複数粒子数での評価）

### 4. 結果分析ツール
- `analyze_benchmark.py`: 結果の可視化・統計分析

## ファイル構成

```
PEM/
├── src/
│   └── pem_simulator.f90       # 修正されたシミュレータ（制御機能追加）
├── input_benchmark.dat         # セル法ON用input
├── input_benchmark_off.dat     # セル法OFF用input
├── benchmark_job.sh            # 基本ベンチマーク用バッチスクリプト
├── detailed_benchmark.sh       # 詳細ベンチマーク用バッチスクリプト
├── analyze_benchmark.py        # 結果分析・可視化スクリプト
└── README_BENCHMARK.md         # この手順書
```

## 実行手順

### 1. 基本ベンチマーク実行

京大スパコンCamphorでの実行:

```bash
# バッチジョブの投入
sbatch benchmark_job.sh

# ジョブの状態確認
squeue -u $USER

# 結果の確認
cat pem_benchmark.[ジョブID].out
```

### 2. 詳細ベンチマーク実行

異なる粒子数での包括的評価:

```bash
# 詳細ベンチマークの実行
sbatch detailed_benchmark.sh

# 結果CSVファイルの確認
cat benchmark_results.csv
```

### 3. 結果の分析・可視化

```bash
# 結果分析スクリプトの実行
python analyze_benchmark.py benchmark_results.csv
```

## 期待される結果

### 1. 計算時間の短縮
- セル法ON: O(N) - 線形時間
- セル法OFF: O(N²) - 二次時間
- 粒子数が増加するほど加速効果が顕著になる

### 2. 加速比の推移
- 小規模（数十粒子）: 2-5倍程度
- 中規模（数百粒子）: 10-50倍程度
- 大規模（数千粒子）: 100倍以上

### 3. 計算複雑度の違い
- セル法ONでは粒子数に対して線形的な時間増加
- セル法OFFでは粒子数の二乗に比例する時間増加

## 注意点

### 1. 実行時間の考慮
- セル法OFF時は計算時間が非常に長くなる可能性
- 粒子数を適切に制限（8層以下を推奨）
- バッチジョブの時間制限を十分に設定

### 2. メモリ使用量
- 粒子数が多い場合はメモリ不足に注意
- 必要に応じてメモリ割り当てを増加

### 3. 結果の解釈
- 実際の加速比は理論値と異なる場合がある
- システムの負荷状況も影響する
- 複数回実行して平均をとることを推奨

## トラブルシューティング

### 1. コンパイルエラー
```bash
# Intel Fortranコンパイラのモジュールロード
module load intel
```

### 2. 実行時エラー
- セルサイズの設定値を確認
- 粒子数がni_maxを超えていないか確認
- 入力ファイルの形式を確認

### 3. 結果ファイルが生成されない
- 出力ディレクトリの権限確認
- ディスク容量の確認
- ジョブの実行ログを確認

## 実行例

### 基本的な実行
```bash
# 手動実行（小規模テスト用）
cd PEM
ifort -O3 -o pem_simulator src/pem_simulator.f90
./pem_simulator input_benchmark.dat
./pem_simulator input_benchmark_off.dat
```

### 結果例
```
=== シミュレーション実行結果 ===
粒子数: 157
計算ステップ数: 30000
実行時間: 23.45 秒
1ステップあたりの平均時間: 0.000781 秒
セル法アルゴリズム: 有効
セルサイズ: 0.0065
セル数 (X方向): 77
セル数 (Z方向): 25
総セル数: 1925
```

## 今後の拡張

### 1. より詳細な分析
- メモリ使用量の測定
- キャッシュ効率の評価
- 並列化効果の検証

### 2. 異なるアルゴリズムの比較
- 他の近傍探索アルゴリズム（kd-tree等）との比較
- 適応的セルサイズの評価

### 3. 実用的な評価
- 実際の物理問題での性能評価
- 異なる粒子分布での評価 